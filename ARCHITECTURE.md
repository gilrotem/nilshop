# NIL Perfumes - Architecture Document

> ×’×¨×¡×”: 1.1 (Final Blueprint - Corrected)
> 
> ××˜×¨×”: ×‘× ×™×™×ª ×××©×§ × ×™×”×•×œ (Backend) ××§×¦×•×¢×™, ×™×¦×™×‘ ×•×××•×‘×˜×— ×œ×—× ×•×ª ×‘×™×©×•× ×‘-Lovable & Supabase.

---

## 1. ×¡×§×™×¨×” ×›×œ×œ×™×ª (Executive Summary)

×”××¢×¨×›×ª ×”×™× ×—× ×•×ª ××™×§×•××¨×¡ (E-commerce) ×œ××•×¦×¨×™ ×™×•×§×¨×” (×‘×©××™×). ×”×“×’×© ×”×•× ×¢×œ ×—×•×•×™×ª ×§× ×™×™×” ×—×œ×§×” ×œ×œ× ×”×¨×©××” (Guest Checkout), ×××™× ×•×ª × ×ª×•× ×™× ×’×‘×•×”×” (Data Integrity), ×•× ×™×”×•×œ ×¤×©×•×˜ ×•×™×¢×™×œ ×¢×‘×•×¨ ×‘×¢×œ×ª ×”×¢×¡×§.

### ×¢×§×¨×•× ×•×ª ××¤×ª×—:

| ×¢×™×§×¨×•×Ÿ | ×ª×™××•×¨ |
|--------|--------|
| **Order First Flow** | ×”×–×× ×” × ×•×¦×¨×ª ×œ×¤× ×™ ×”×ª×©×œ×•× ×›×“×™ ×œ××¤×©×¨ ××¢×§×‘ ×•×ª××™××•×ª ×œ×—×©×‘×•× ×™×•×ª |
| **Guest Checkout** | ××™×Ÿ ×”×¨×©××ª ×œ×§×•×—×•×ª. ×–×™×”×•×™ ××•×˜×•××˜×™ ×œ×¤×™ ××™××™×™×œ |
| **Data Snapshots** | ×©××™×¨×ª ××—×™×¨ ×•×©× ××•×¦×¨ ×‘×¢×ª ×”×¨×›×™×©×” (×œ×× ×™×¢×ª ×¢×™×•×•×ª ×”×™×¡×˜×•×¨×™) |
| **Admin Security** | ×›× ×™×¡×” ×œ× ×™×”×•×œ ×‘×××¦×¢×•×ª ×§×•×“ ×—×“-×¤×¢××™ ×œ××™×™×œ (OTP) ×‘×œ×‘×“ |
| **Micro-Notifications** | ×”×ª×¨××•×ª ×‘×•×˜ ×˜×œ×’×¨× ×œ××“××™×Ÿ + ××™××™×™×œ ××¢×•×¦×‘ ×œ×œ×§×•×— |

---

## 2. ××‘× ×” ×‘×¡×™×¡ ×”× ×ª×•× ×™× (Database Schema)

### ERD - Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    products     â”‚       â”‚   customers     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ slug (UNIQUE)   â”‚       â”‚ email (UNIQUE)  â”‚
â”‚ name            â”‚       â”‚ full_name       â”‚
â”‚ price           â”‚       â”‚ phone           â”‚
â”‚ in_stock        â”‚       â”‚ total_orders    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ total_spent     â”‚
         â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  order_items    â”‚â—„â”€â”€â”€â”€â”€â”€â”‚     orders      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ order_id (FK)   â”‚       â”‚ order_number    â”‚
â”‚ product_id (FK) â”‚       â”‚ customer_id(FK) â”‚
â”‚ name (snapshot) â”‚       â”‚ customer_email  â”‚
â”‚ price_at_purchaseâ”‚      â”‚ status          â”‚
â”‚ quantity        â”‚       â”‚ shipping_cost   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ total_amount    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚shipping_options â”‚       â”‚    coupons      â”‚       â”‚   user_roles    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ name            â”‚       â”‚ code (UNIQUE)   â”‚       â”‚ user_id (FK)    â”‚
â”‚ price           â”‚       â”‚ discount_type   â”‚       â”‚ role            â”‚
â”‚ is_active       â”‚       â”‚ discount_value  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ expires_at      â”‚
                          â”‚ max_uses        â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ×˜×‘×œ××•×ª - ×¤×™×¨×•×˜ ××œ×

### 3.1 Products (××•×¦×¨×™×)
```
| ×©×“×”          | ×˜×™×¤×•×¡      | ×ª×™××•×¨                    |
|--------------|------------|--------------------------|
| id           | UUID (PK)  | ××–×”×” ×™×™×—×•×“×™              |
| slug         | TEXT       | URL-friendly name        |
| name         | TEXT       | ×©× ×”××•×¦×¨                 |
| description  | TEXT       | ×ª×™××•×¨                    |
| price        | NUMERIC    | ××—×™×¨ (>=0)               |
| image_url    | TEXT       | ×ª××•× ×” ×¨××©×™×ª              |
| in_stock     | BOOLEAN    | ×”×× ×‘××œ××™                |
| display_order| INT        | ×¡×“×¨ ×ª×¦×•×’×”                |
| created_at   | TIMESTAMPTZ| ×ª××¨×™×š ×™×¦×™×¨×”              |
| updated_at   | TIMESTAMPTZ| ×ª××¨×™×š ×¢×“×›×•×Ÿ              |
```

### 3.2 Customers (×œ×§×•×—×•×ª)
```
| ×©×“×”          | ×˜×™×¤×•×¡      | ×ª×™××•×¨                    |
|--------------|------------|--------------------------|
| id           | UUID (PK)  | ××–×”×” ×™×™×—×•×“×™              |
| email        | TEXT       | ××™××™×™×œ (×™×™×—×•×“×™)          |
| full_name    | TEXT       | ×©× ××œ×                   |
| phone        | TEXT       | ×˜×œ×¤×•×Ÿ                    |
| total_orders | INT        | ×¡×”"×› ×”×–×× ×•×ª              |
| total_spent  | NUMERIC    | ×¡×”"×› ×”×•×¦××•×ª              |
| last_order_at| TIMESTAMPTZ| ×”×–×× ×” ××—×¨×•× ×”             |
| created_at   | TIMESTAMPTZ| ×ª××¨×™×š ×™×¦×™×¨×”              |
```

### 3.3 Orders (×”×–×× ×•×ª)
```
| ×©×“×”              | ×˜×™×¤×•×¡        | ×ª×™××•×¨                    |
|------------------|--------------|--------------------------|
| id               | UUID (PK)    | ××–×”×” ×™×™×—×•×“×™              |
| order_number     | BIGINT       | ××¡×¤×¨ ×”×–×× ×” ×§×¨×™× (1000+)  |
| customer_id      | UUID (FK)    | ×§×™×©×•×¨ ×œ×œ×§×•×—              |
| customer_email   | TEXT         | ××™××™×™×œ (snapshot)        |
| recipient_name   | TEXT         | ×©× ××§×‘×œ                  |
| phone            | TEXT         | ×˜×œ×¤×•×Ÿ                    |
| city             | TEXT         | ×¢×™×¨                      |
| street           | TEXT         | ×¨×—×•×‘                     |
| house_number     | TEXT         | ××¡×¤×¨ ×‘×™×ª                 |
| apartment        | TEXT         | ×“×™×¨×”                     |
| zip_code         | TEXT         | ××™×§×•×“                    |
| notes            | TEXT         | ×”×¢×¨×•×ª                    |
| shipping_option_id| UUID (FK)   | ××¤×©×¨×•×ª ××©×œ×•×—             |
| shipping_cost    | NUMERIC      | ×¢×œ×•×ª ××©×œ×•×—               |
| products_total   | NUMERIC      | ×¡×”"×› ××•×¦×¨×™×              |
| discount_amount  | NUMERIC      | ×¡×›×•× ×”× ×—×”                |
| coupon_code      | TEXT         | ×§×•×“ ×§×•×¤×•×Ÿ                |
| total_amount     | NUMERIC      | ×¡×”"×› ×œ×ª×©×œ×•×              |
| status           | ENUM         | ×¡×˜×˜×•×¡ ×”×–×× ×”              |
| payment_provider_id| TEXT       | ××¡××›×ª× ×ª×©×œ×•×             |
| created_at       | TIMESTAMPTZ  | ×ª××¨×™×š ×™×¦×™×¨×”              |
| updated_at       | TIMESTAMPTZ  | ×ª××¨×™×š ×¢×“×›×•×Ÿ              |
```

### 3.4 Order Items (×¤×¨×™×˜×™ ×”×–×× ×”)
```
| ×©×“×”              | ×˜×™×¤×•×¡      | ×ª×™××•×¨                    |
|------------------|------------|--------------------------|
| id               | UUID (PK)  | ××–×”×” ×™×™×—×•×“×™              |
| order_id         | UUID (FK)  | ×§×™×©×•×¨ ×œ×”×–×× ×”             |
| product_id       | UUID (FK)  | ×§×™×©×•×¨ ×œ××•×¦×¨ (nullable)   |
| name             | TEXT       | ×©× ×”××•×¦×¨ (snapshot)      |
| price_at_purchase| NUMERIC    | ××—×™×¨ ×‘×¨×’×¢ ×”×§× ×™×™×”         |
| quantity         | INT        | ×›××•×ª                     |
```

### 3.5 Shipping Options (××¤×©×¨×•×™×•×ª ××©×œ×•×—)
```
| ×©×“×”          | ×˜×™×¤×•×¡      | ×ª×™××•×¨                    |
|--------------|------------|--------------------------|
| id           | UUID (PK)  | ××–×”×” ×™×™×—×•×“×™              |
| name         | TEXT       | ×©× (×©×œ×™×—/××™×¡×•×£)          |
| price        | NUMERIC    | ××—×™×¨                     |
| is_active    | BOOLEAN    | ×¤×¢×™×œ                     |
| display_order| INT        | ×¡×“×¨ ×ª×¦×•×’×”                |
```

### 3.6 Coupons (×§×•×¤×•× ×™×)
```
| ×©×“×”              | ×˜×™×¤×•×¡        | ×ª×™××•×¨                    |
|------------------|--------------|--------------------------|
| id               | UUID (PK)    | ××–×”×” ×™×™×—×•×“×™              |
| code             | TEXT         | ×§×•×“ ×”×§×•×¤×•×Ÿ (×™×™×—×•×“×™)      |
| discount_type    | ENUM         | percent / fixed          |
| discount_value   | NUMERIC      | ×¢×¨×š ×”×”× ×—×”                |
| min_order_amount | NUMERIC      | ××™× ×™××•× ×”×–×× ×”            |
| max_uses         | INT          | ××§×¡×™××•× ×©×™××•×©×™×          |
| usage_count      | INT          | ×©×™××•×©×™× ×¢×“ ×›×”            |
| expires_at       | TIMESTAMPTZ  | ×ª××¨×™×š ×ª×¤×•×’×”              |
| is_active        | BOOLEAN      | ×¤×¢×™×œ                     |
| created_at       | TIMESTAMPTZ  | ×ª××¨×™×š ×™×¦×™×¨×”              |
```

### 3.7 User Roles (×”×¨×©××•×ª)
```
| ×©×“×”      | ×˜×™×¤×•×¡      | ×ª×™××•×¨                    |
|----------|------------|--------------------------|
| id       | UUID (PK)  | ××–×”×” ×™×™×—×•×“×™              |
| user_id  | UUID (FK)  | ×§×™×©×•×¨ ×œ-auth.users       |
| role     | ENUM       | admin / moderator        |
```

---

## 4. ×¡×˜×˜×•×¡×™× (Enums)

### order_status
```
pending    â†’ × ×•×¦×¨, ×××ª×™×Ÿ ×œ×ª×©×œ×•×
paid       â†’ ×©×•×œ× ×‘×”×¦×œ×—×”
processing â†’ ×‘×˜×™×¤×•×œ/××¨×™×–×”
shipped    â†’ ×™×¦× ×œ××©×œ×•×—
delivered  â†’ × ××¡×¨
cancelled  â†’ ×‘×•×˜×œ
refunded   â†’ ×”×•×—×–×¨ ×›×¡×£
```

### discount_type
```
percent â†’ ×”× ×—×” ×‘××—×•×–×™×
fixed   â†’ ×”× ×—×” ×‘×¡×›×•× ×§×‘×•×¢
```

### app_role
```
admin     â†’ ×’×™×©×” ××œ××”
moderator â†’ ×’×™×©×” ××•×’×‘×œ×ª (×¢×ª×™×“×™)
```

---

## 5. ××‘×˜×—×” (Security)

### 5.1 RLS Policy Matrix

| ×˜×‘×œ×” | SELECT | INSERT | UPDATE | DELETE |
|------|--------|--------|--------|--------|
| products | âœ… Public | ğŸ” Admin | ğŸ” Admin | ğŸ” Admin |
| customers | ğŸ” Admin | âœ… Public | ğŸ” Admin | âŒ |
| orders | ğŸ” Admin | âœ… Public | ğŸ” Admin | âŒ |
| order_items | ğŸ” Admin | âœ… Public | âŒ | âŒ |
| shipping_options | âœ… Public | ğŸ” Admin | ğŸ” Admin | ğŸ” Admin |
| coupons | âœ… Public (code only) | ğŸ” Admin | ğŸ” Admin | ğŸ” Admin |
| user_roles | ğŸ” Admin | ğŸ” Admin | ğŸ” Admin | ğŸ” Admin |

### 5.2 Authentication
- **Method:** OTP (One-Time Password) ×œ××™×™×œ
- **Sign Up:** ×—×¡×•×. ××©×ª××©×™× × ×•×¦×¨×™× ×™×“× ×™×ª ×‘×œ×‘×“.
- **Session:** 7 ×™××™×

---

## 6. ×ª×”×œ×™×›×™× ×¢×¡×§×™×™× (Workflows)

### 6.1 Checkout Flow
```
1. ×œ×§×•×— ×××œ× ×¢×’×œ×” ×•×œ×•×—×¥ "×œ×ª×©×œ×•×"
2. ××¢×¨×›×ª ×‘×•×“×§×ª ×§×•×¤×•×Ÿ ×•××—×©×‘×ª ×¡×”"×›
3. Backend:
   - ×‘×•×“×§ ×× ×”××™××™×™×œ ×§×™×™× ×‘-customers â†’ ×× ×œ×, ×™×•×¦×¨ ×—×“×©
   - ×™×•×¦×¨ ×¨×©×•××” ×‘-orders ×¢× ×¡×˜×˜×•×¡ 'pending'
   - ×©×•××¨ ×¤×¨×™×˜×™× ×‘-order_items ×¢× snapshot
4. ×œ×§×•×— ××•×¢×‘×¨ ×œ-YaadPay ×¢× order_number
5. YaadPay ××—×–×™×¨ ×ª×©×•×‘×” (Webhook)
```

### 6.2 Payment Webhook
```
1. Edge Function ××§×‘×œ×ª ××™×©×•×¨ ×-YaadPay
2. ××•×•×“××ª ×©×”×¡×›×•× ×ª×•××
3. ××¢×“×›× ×ª ×¡×˜×˜×•×¡ ×œ-'paid'
4. ××¢×“×›× ×ª total_spent ×©×œ ×”×œ×§×•×—
5. ×©×•×œ×—×ª ××™×™×œ ×œ×œ×§×•×—
6. ×©×•×œ×—×ª ×”×•×“×¢×ª ×˜×œ×’×¨× ×œ××“××™×Ÿ
```

---

## 7. ××™× ×˜×’×¨×¦×™×•×ª

| ×©×™×¨×•×ª | ×©×™××•×© | ×¡×•×’ |
|--------|--------|------|
| YaadPay | ×¡×œ×™×§×” | Redirect API |
| Resend | ××™××™×™×œ×™× | API |
| Telegram Bot | ×”×ª×¨××•×ª ××“××™×Ÿ | HTTP API |

---

## 8. ××‘× ×” ×××©×§ ×”× ×™×”×•×œ

```
/admin
â”œâ”€â”€ /login              â†’ ×”×ª×—×‘×¨×•×ª OTP
â”œâ”€â”€ /                   â†’ Dashboard
â”œâ”€â”€ /orders             â†’ ×¨×©×™××ª ×”×–×× ×•×ª
â”‚   â””â”€â”€ /:id            â†’ ×¤×¨×˜×™ ×”×–×× ×”
â”œâ”€â”€ /products           â†’ ×¨×©×™××ª ××•×¦×¨×™×
â”‚   â””â”€â”€ /:id/edit       â†’ ×¢×¨×™×›×ª ××•×¦×¨
â”œâ”€â”€ /coupons            â†’ ×¨×©×™××ª ×§×•×¤×•× ×™×
â”‚   â””â”€â”€ /new            â†’ ×§×•×¤×•×Ÿ ×—×“×©
â””â”€â”€ /settings           â†’ ×”×’×“×¨×•×ª
```

---

## 9. ×§×‘×¦×™ SQL

×”×¡×§×¨×™×¤×˜×™× × ××¦××™× ×‘:
- `database/001_schema.sql` - ××‘× ×” ×˜×‘×œ××•×ª
- `database/002_rls.sql` - ××‘×˜×—×” ×•×”×¨×©××•×ª
- `database/003_seed.sql` - × ×ª×•× ×™ ×”×ª×—×œ×” (××•×¤×¦×™×•× ×œ×™)
